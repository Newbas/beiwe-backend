<html>
  <head>
    <meta charset="utf-8">
    <!--  In order to use promises, like this example, you will need to include this polyfill to add promises
        functionality to the built in Tableau WDC browser (it does not have ES6 functionality by default)  -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.2/js.cookie.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <meta http-equiv="Cache-Control" content="no-store" />
    <script>
      (function () {
        var myConnector = tableau.makeConnector();
        myConnector.getSchema = function (schemaCallback) {
          var cols = [
            {id: 'participant_id', dataType: tableau.dataTypeEnum.string,},
            {id: 'study_id', dataType: tableau.dataTypeEnum.string,},
            {id: 'date', dataType: tableau.dataTypeEnum.date,},
            {id: 'distance_diameter', dataType: tableau.dataTypeEnum.int,},
            {id: 'distance_from_home', dataType: tableau.dataTypeEnum.int,},
            {id: 'distance_traveled', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_distance_average', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_distance_standard_deviation', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_duration_average', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_duration_standard_deviation', dataType: tableau.dataTypeEnum.int,},
            {id: 'gps_data_missing_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'home_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'physical_circadian_rhythm', dataType: tableau.dataTypeEnum.float,},
            {id: 'physical_circadian_rhythm_stratified', dataType: tableau.dataTypeEnum.float,},
            {id: 'radius_of_gyration', dataType: tableau.dataTypeEnum.int,},
            {id: 'significant_location_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'significant_location_entropy', dataType: tableau.dataTypeEnum.string,},
            {id: 'stationary_fraction', dataType: tableau.dataTypeEnum.string,},
            {id: 'text_incoming_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_incoming_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_incoming_length', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_incoming_responsiveness', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_outgoing_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_outgoing_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_outgoing_length', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_reciprocity', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_responsiveness', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_outgoing_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_outgoing_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_outgoing_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'acceleration_direction', dataType: tableau.dataTypeEnum.string,},
            {id: 'accelerometer_coverage_fraction', dataType: tableau.dataTypeEnum.string,},
            {id: 'accelerometer_signal_variability', dataType: tableau.dataTypeEnum.string,},
            {id: 'accelerometer_univariate_summaries', dataType: tableau.dataTypeEnum.float,},
            {id: 'device_proximity', dataType: tableau.dataTypeEnum.bool,},
            {id: 'total_power_events', dataType: tableau.dataTypeEnum.int,},
            {id: 'total_screen_events', dataType: tableau.dataTypeEnum.int,},
            {id: 'total_unlock_events', dataType: tableau.dataTypeEnum.int,},
            {id: 'awake_onset_time', dataType: tableau.dataTypeEnum.datetime,},
            {id: 'sleep_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'sleep_onset_time', dataType: tableau.dataTypeEnum.datetime,},
          ];
          var tableSchema = {
                id: "StudyData",
                alias: "Data from the Beiwe WDC on study with id: '{{ study_id }}'",
                columns: cols
            };
          schemaCallback([tableSchema]);
        };

        myConnector.getData = function (table, doneCallback) {
            $.ajax({
              dataType: "json",
              url: "http://localhost:8080/api/v0/studies/{{ study_id}}/summary-statistics/daily",
              data: "",
              headers: {
                "X-Access-Key-Id": tableau.username,
                "X-Access-Key-Secret": tableau.password
              },
              error: function(response) {
                tableau.log(response);
                tableau.abortWithError(response.responseText)
                //tableau.abortWithError("something went wrong")
              },
              success:
                function(resp) {
                  var feat = resp;
                  var tableData = [];

                  // Iterate over the JSON object
                  for (var i = 0, len = feat.length; i < len; i++) {
                    tableData.push({
                      "participant_id": feat[i].participant_id,
                      "study_id": feat[i].study_id,
                      "date": feat[i].date,
                      "distance_diameter": feat[i].distance_diameter,
                      "distance_from_home": feat[i].distance_from_home,
                      "distance_traveled": feat[i].distance_traveled,
                      "flight_distance_average": feat[i].flight_distance_average,
                      "flight_distance_standard_deviation": feat[i].flight_distance_standard_deviation,
                      "flight_duration_average": feat[i].flight_duration_average,
                      "flight_duration_standard_deviation": feat[i].flight_duration_standard_deviation,
                      "gps_data_missing_duration": feat[i].gps_data_missing_duration,
                      "home_duration": feat[i].home_duration,
                      "physical_circadian_rhythm": feat[i].physical_circadian_rhythm,
                      "physical_circadian_rhythm_stratified": feat[i].physical_circadian_rhythm_stratified,
                      "radius_of_gyration": feat[i].radius_of_gyration,
                      "significant_location_count": feat[i].significant_location_count,
                      "significant_location_entropy": feat[i].significant_location_entropy,
                      "stationary_fraction": feat[i].stationary_fraction,
                      "text_incoming_count": feat[i].text_incoming_count,
                      "text_incoming_degree": feat[i].text_incoming_degree,
                      "text_incoming_length": feat[i].text_incoming_length,
                      "text_incoming_responsiveness": feat[i].text_incoming_responsiveness,
                      "text_outgoing_count": feat[i].text_outgoing_count,
                      "text_outgoing_degree": feat[i].text_outgoing_degree,
                      "text_outgoing_length": feat[i].text_outgoing_length,
                      "text_reciprocity": feat[i].text_reciprocity,
                      "call_incoming_count": feat[i].call_incoming_count,
                      "call_incoming_degree": feat[i].call_incoming_degree,
                      "call_incoming_duration": feat[i].call_incoming_duration,
                      "call_incoming_responsiveness": feat[i].call_incoming_responsiveness,
                      "call_outgoing_count": feat[i].call_outgoing_count,
                      "call_outgoing_degree": feat[i].call_outgoing_degree,
                      "call_outgoing_duration": feat[i].call_outgoing_duration,
                      "acceleration_direction": feat[i].acceleration_direction,
                      "accelerometer_coverage_fraction": feat[i].accelerometer_coverage_fraction,
                      "accelerometer_signal_variability": feat[i].accelerometer_signal_variability,
                      "accelerometer_univariate_summaries": feat[i].accelerometer_univariate_summaries,
                      "device_proximity": feat[i].device_proximity,
                      "total_power_events": feat[i].total_power_events,
                      "total_screen_events": feat[i].total_screen_events,
                      "total_unlock_events": feat[i].total_unlock_events,
                      "awake_onset_time": feat[i].awake_onset_time,
                      "sleep_duration": feat[i].sleep_duration,
                      "sleep_onset_time": feat[i].sleep_onset_time
                    });
                  }
                  table.appendRows(tableData);
                  doneCallback();
                }});
        };
        tableau.registerConnector(myConnector);
        $(document).ready(function() {
            $("#submitButton").click(function() {
                tableau.username = document.getElementById('access_key_id').value
                tableau.password = document.getElementById('access_key_secret').value
                tableau.connectionName = "Study: {{ study_id }}"; // This will be the data source name in Tableau
                tableau.submit(); // This sends the connector object to Tableau
            });
          });
      })();
    </script>
  <head/>
  <body>
    <h1>Study Data Web Data Connector for Study Data</h1>
    <div>For the study with ID: {{ study_id }}</div>
    <div class="container container-table">
      <div class="row vertical-center-row">
        <div class="text-center col-md-4 col-md-offset-4">
          <label>Access Key Id:</label><input id="access_key_id" type="text">
          <label>Access Key Secret:</label><input id="access_key_secret" type="password">
        </div>
      </div>
    </div>
    <button id="submitButton">Get Data</button>
  </body>
</html>