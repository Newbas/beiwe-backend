<html>
  <head>
    <meta charset="utf-8">
    <!--  In order to use promises, like this example, you will need to include this polyfill to add promises
        functionality to the built in Tableau WDC browser (it does not have ES6 functionality by default)  -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.2/js.cookie.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <meta http-equiv="Cache-Control" content="no-store" />
    <script>
      (function () {
        var myConnector = tableau.makeConnector();
        myConnector.getSchema = function (schemaCallback) {

          var cols = {{ (cols|safe) }}
          /*
              [
            {id: 'participant_id', dataType: tableau.dataTypeEnum.string,},
            {id: 'study_id', dataType: tableau.dataTypeEnum.string,},
            {id: 'date', dataType: tableau.dataTypeEnum.date,},
            {id: 'distance_diameter', dataType: tableau.dataTypeEnum.int,},
            {id: 'distance_from_home', dataType: tableau.dataTypeEnum.int,},
            {id: 'distance_traveled', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_distance_average', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_distance_standard_deviation', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_duration_average', dataType: tableau.dataTypeEnum.int,},
            {id: 'flight_duration_standard_deviation', dataType: tableau.dataTypeEnum.int,},
            {id: 'gps_data_missing_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'home_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'physical_circadian_rhythm', dataType: tableau.dataTypeEnum.float,},
            {id: 'physical_circadian_rhythm_stratified', dataType: tableau.dataTypeEnum.float,},
            {id: 'radius_of_gyration', dataType: tableau.dataTypeEnum.int,},
            {id: 'significant_location_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'significant_location_entropy', dataType: tableau.dataTypeEnum.string,},
            {id: 'stationary_fraction', dataType: tableau.dataTypeEnum.string,},
            {id: 'text_incoming_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_incoming_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_incoming_length', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_incoming_responsiveness', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_outgoing_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_outgoing_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_outgoing_length', dataType: tableau.dataTypeEnum.int,},
            {id: 'text_reciprocity', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_incoming_responsiveness', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_outgoing_count', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_outgoing_degree', dataType: tableau.dataTypeEnum.int,},
            {id: 'call_outgoing_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'acceleration_direction', dataType: tableau.dataTypeEnum.string,},
            {id: 'accelerometer_coverage_fraction', dataType: tableau.dataTypeEnum.string,},
            {id: 'accelerometer_signal_variability', dataType: tableau.dataTypeEnum.string,},
            {id: 'accelerometer_univariate_summaries', dataType: tableau.dataTypeEnum.float,},
            {id: 'device_proximity', dataType: tableau.dataTypeEnum.bool,},
            {id: 'total_power_events', dataType: tableau.dataTypeEnum.int,},
            {id: 'total_screen_events', dataType: tableau.dataTypeEnum.int,},
            {id: 'total_unlock_events', dataType: tableau.dataTypeEnum.int,},
            {id: 'awake_onset_time', dataType: tableau.dataTypeEnum.datetime,},
            {id: 'sleep_duration', dataType: tableau.dataTypeEnum.int,},
            {id: 'sleep_onset_time', dataType: tableau.dataTypeEnum.datetime,},
          ];
          */

          var tableSchema = {
                id: "StudyData",
                alias: "Data from the Beiwe WDC on study with id: '{{ study_id }}'",
                columns: cols
            };
          schemaCallback([tableSchema]);
        };

        myConnector.getData = function (table, doneCallback) {
            $.ajax({
              dataType: "json",
              url: "{{ url_for('summary_statistics_daily_study_view', study_id=study_id) }}" + tableau.connectionData,
              headers: {
                "X-Access-Key-Id": tableau.username,
                "X-Access-Key-Secret": tableau.password
              },
              error:
                function(response) {
                tableau.log(response); //the tableau log is accessible through the tableau WDC simulator for debugging
                tableau.abortWithError(response.responseText);
              },
              success:
                function(resp) {
                  table.appendRows(resp);
                  doneCallback();
                }});
        };
        tableau.registerConnector(myConnector);
        $(document).ready(function() {
            $("#submitButton").click(function() {
                tableau.username = document.getElementById('access_key_id').value
                tableau.password = document.getElementById('access_key_secret').value
                tableau.connectionName = "Study: {{ study_id }}"; // This will be the data source name in Tableau
                tableau.connectionData = window.location.search; //save the query string which contains parameters for the api call
                tableau.submit(); // This sends the connector object to Tableau
            });
          });
      })();
    </script>
  <head/>
  <body>
    <h1>Study Data Web Data Connector for Study Data</h1>
    <div>For the study with ID: {{ study_id }}</div>
    <div class="container container-table">
      <div class="row vertical-center-row">
        <div class="text-center col-md-4 col-md-offset-4">
          <label>Access Key Id:</label><input id="access_key_id" type="text">
          <label>Access Key Secret:</label><input id="access_key_secret" type="password">
        </div>
      </div>
    </div>
    <button id="submitButton">Get Data</button>
  </body>
</html>